---
format:
  pdf:
    include-in-header: preamble_russian.tex
    pdf-engine: lualatex
    documentclass: article
    urlcolor: maincolor
    linkcolor: maincolor
    number-sections: false
params:
  abundance_file_path: NULL
  participant_id: NULL
  sample_prefix: NULL
title: |
  ![](elinav_logo.png){width=5cm} \
  \
  **ОТЧЕТ ОБ АНАЛИЗЕ МИКРОБИОМА** \
  ИН участника: `r params$participant_id`
---

```{r texts, include=FALSE}
# All texts
introduction <- "Микробиом кишечника состоит из триллионов микроорганизмов, включая бактерии, вирусы, грибки и археи, которые живут в пищеварительном тракте. Эти микроорганизмы способствуют пищеварению, поддерживают функцию иммунной системы и влияют на обмен веществ. Состав микробиома может изменяться под воздействием питания, образа жизни и генетических факторов.\n\n 

В этом отчете представлен анализ микробиома вашего кишечника по методу дробовика (shotgun sequencing). Это высокоточная технология, которая позволяет выявить как известные, так и ранее неизученные микроорганизмы. Сравнивая состав вашего микробиома с показателями других участников исследования, мы пытаемся лучше понять, как кишечные бактерии связаны с общим состоянием здоровья человека.\n\n

Далее представлен обзор бактерий, которые есть в вашем образце, а также описание основных групп бактерий, которые обычно присутствуют в кишечнике человека. В завершение мы расскажем о некоторых отдельных бактериях вашего микробиома, и предложим дополнительные материалы для ознакомления, если вы захотите узнать больше."

diversity <- "Микробное разнообразие — это совокупность различных бактерий и других микроорганизмов в кишечнике. Часто чем выше разнообразие, тем лучше состояние здоровья человека. Низкое разнообразие микроорганизмов может быть связано с некоторыми заболеваниями. На микробный состав могут влиять различные факторы, включая питание, прием лекарств и образ жизни.\\par\\vspace{1.0em}"

div_explanations <- list("Shannon index" = "Индекс Шеннона — это показатель микробного разнообразия, который учитывает как количество различных видов микроорганизмов, так и равномерность их распределения. Высокие значения индекса Шеннона свидетельствуют о более разнообразном и сбалансированном микробиоме, и часто это указывает на хорошее состояние здоровья человека. ",
                        "Species richness" = "Видовое богатство — это количество разных видов микроорганизмов, которые находятся в кишечнике. Высокие значения видового богатства обычно указывают на более разнообразный микробиом, и часто это говорит о хорошем состоянии здоровья и устойчивости организма человека. ")

phylum_explanation <- "На диаграмме представлено распределение крупных таксономических групп бактерий (типов) в микробиоме вашего кишечника. Шесть самых распространенных групп показаны по отдельности. Все оставшиеся группы объединены в категорию «прочие типы».\\par\\vspace{1.0em}"

main_groups <- list(
  "Bacteroidota" = "\\texten{Bacteroidetes} — одна из доминирующих групп бактерий в кишечнике. Низкие уровни Bacteroidetes связаны с развитием ожирения, повышенным содержанием жировой ткани в теле и нарушением регуляции показателей глюкозы в крови. Высокое содержание этих бактерий способствует лучшему обмену веществ и хорошей реакции организма на диеты для снижения веса. Некоторые исследования указывают на смешанные или противоположные эффекты в зависимости от индивидуальных факторов.",
  "Bacillota" = "\\texten{Firmicutes} — еще одна большая группа бактерий. Высокие уровни Firmicutes наблюдаются при ожирении и у людей, которые питаются продуктами с большим содержанием жиров и сахара. Низкие уровни этих бактерий сопровождает лучший обмен веществ, низкие значения холестерина и более здоровое состояние кишечника.",
  "Pseudomonadota" = "\\texten{Proteobacteria} — это разнотипная группа бактерий, состоящая из множества видов, которые сопровождают воспалительные процессы и метаболические нарушения. Высокое содержание Proteobacteria связано сахарным диабетом 2 типа, ожирением и инсулинорезистентностью. Низкие уровни этих бактерий наблюдаются параллельно с лучшим контролем уровня сахара в крови, а также у людей, которые употребляют в пищу много клетчатки."
)

species_explanation <- "На диаграмме представлено распределение видов бактерий в микробиоме вашего кишечника. Двадцать самых распространенных видов показаны по отдельности. Все оставшиеся виды объединены в категорию «прочие виды».\\par\\vspace{1.0em}"

taxa_explanations <- list(
  "Bacteroides" = "Виды \\texten{Bacteroides} — это бактерии, которые широко представлены в кишечнике. Низкие уровни Bacteroides связаны с ожирением и плохим контролем уровня глюкозы в крови. Высокое содержание этих бактерий наблюдается при коррекции питания, способствуя снижению веса.",
  "Parabacteroides" = "Повышенный уровень \\texten{Parabacteroides} связан с плохим контролем уровня сахара в крови и наблюдается у людей, которые питаются продуктами с высоким содержанием жиров. Низкие уровни этих бактерий встречаются у людей, которые хорошо отвечают на лечение противодиабетическими препаратами.",
  "Prevotella" = "\\texten{Prevotella} — это бактерии, которые часто встречаются у людей, которые употребляют много клетчатки и питаются преимущественно пищей растительного происхождения. Высокие уровни этих бактерий часто наблюдаются у людей, которые едят цельнозерновые продукты, бобовые и овощи. Некоторые исследования показывают, что высокое соотношение \\texten{Prevotella} к Bacteroides может способствовать метаболизму глюкозы, однако данные противоречивы.",
  "Escherichia" = "Род \\texten{Escherichia} включает как полезные, так и потенциально патогенные виды. Некоторые из них, например, \\texten{Escherichia coli}, важны для здоровья кишечника и синтеза витаминов. Другие же виды могут провоцировать воспаление кишечника, развитие инфекций и метаболических нарушений. Баланс видов \\texten{Escherichia} в кишечнике зависит от питания и функции иммунной системы.",
  "Faecalibacterium" = "Бактерии рода \\texten{Faecalibacterium}, особенно \\texten{Faecalibacterium prausnitzii}, считаются полезными представителями кишечной микрофлоры. Они известны своей способностью продуцировать короткоцепочечные жирные кислоты (КЦЖК), например, бутират. Эти соединения помогают поддерживать здоровье кишечника и уменьшают воспалительные процессы. Повышенный уровень Faecalibacterium наблюдается в связи с низкими показателями системного воспаления, лучшей барьерной функции кишечника и лучшем контроле уровня глюкозы в крови.",
  "Akkermansia muciniphila" = "\\texten{Akkermansia muciniphila} — бактерия класса \\texten{Verrucomicrobia}, которая участвует в поддержании здоровья кишечника. Эти бактерии хорошо развиваются в присутствии муцина — основного компонента слизистой оболочки, который защищает внутреннюю выстилку кишечника и обеспечивает целостность кишечного барьера. Повышенные уровни A. muciniphila связаны с улучшением метаболизма, лучшей чувствительностью к инсулину и сниженным содержанием жировой ткани в теле.",
  # "Lactobacillus" = "\\texten{Lactobacillus} — это род бактерий, который часто встречается в пробиотических продуктах, таких как йогурт и кефир. Эти бактерии улучшают здоровье кишечника, вырабатывая молочную кислоту, которая помогает поддерживать оптимальный pH и подавляет рост патогенных микроорганизмов. Высокие уровни Lactobacillus способствуют улучшению барьерной функции кишечника, снижению массы тела и улучшению пищеварения.",
  "Bifidobacterium" = "\\texten{Bifidobacterium} — это известный род пробиотиков, который играет ключевую роль в здоровье кишечника. Высокие уровни \\texten{Bifidobacterium} связаны с улучшенным пищеварением, усилением иммунитета и лучшим контролем уровня глюкозы в крови. Эти бактерии часто встречаются у людей, которые употребляют в пищу ферментированные продукты и пребиотическую клетчатку.",
  "Roseburia" = "\\texten{Roseburia} — это род полезных кишечных бактерий, который играет основную роль в метаболизме углеводов, особенно в ферментации клетчатки. Эти бактерии расщепляют сложные углеводы до короткоцепочечных жирных кислот, таких как бутират, которые способствуют здоровью кишечника и уменьшению воспалительных процессов. Высокое содержание \\texten{Roseburia} обычно наблюдается у людей, которые употребляют в пищу много клетчатки, поскольку эти бактерии хорошо растут при наличии неперевариваемых пищевых волокон. Высокие уровни \\texten{Roseburia} связаны с лучшим контролем уровня сахара в крови, лучшей чувствительностью к инсулину и общим метаболическим здоровьем.",
  "Desulfovibrionaceae" = "Повышенное содержание \\texten{Desulfovibrionaceae} — семейства сульфатредуцирующих бактерий — связано с рядом отрицательных последствий для здоровья. Эти бактерии продуцируют сероводород — соединение, которое способствует развитию воспаления в кишечнике и нарушает его барьерную функцию. Повышенный уровень \\texten{Desulfovibrionaceae} связан с плохим контролем уровня глюкозы в крови, инсулинорезистентностью и ожирением.",
  "Dorea formicigenerans" = "\\texten{Dorea formicigenerans} — кишечная бактерия, которая способствует здоровому метаболизму. Высокие уровни \\texten{Dorea formicigenerans} связаны с меньшей массой тела и лучшими показателями метаболизма. Эта бактерия участвует в ферментации пищевых волокон с образованием короткоцепочечных жирных кислот, таких как бутират, которые обладают противовоспалительным действием и помогают поддерживать здоровье кишечника."
)

readmore <- "Хотите узнать больше о микробиоме кишечника? Вот несколько полезных ресурсов:\n\n
- \\href{https://my.clevelandclinic.org/health/body/25201-gut-microbiome}{Общие сведения} — обзор информации о микробиоме кишечника от клиники Кливленда.\n
- \\href{https://asm.org/resource-pages/microbiome-resources}{Информация} о микробиоме кишечника от Американского общества микробиологии.\n
- \\href{https://patient.gastro.org/probiotics/}{Руководство по применению пробиотиков} от Американской ассоциации гастроэнтерологов.\n
- \\href{https://nutritionsource.hsph.harvard.edu/microbiome/}{Питание и микробиом} — материалы Школы общественного здравоохранения им. Т. Х. Чана Гарвардского университета.\\par\\vspace{2.0em}"

disclaimer <- "Этот отчет основан на анализе одного образца кала, который отражает состояние микробиома вашего кишечника в текущий момент времени. Состав микробиома может изменяться под влиянием таких факторов, как питание, прием лекарств и образ жизни. Поэтому интерпретировать результаты следует с осторожностью. Эти данные не представляют окончательную оценку состояния здоровья вашего кишечника. При наличии вопросов относительно своего здоровья, обратитесь к врачу."
```

```{r functions, include = FALSE}
create_infobox <- function(content, title = "Key Findings") {
  # Escape quotes in title if present
  title <- gsub('"', '\\"', title)
  cat("\\begin{tcolorbox}[",
      "colback=lightgray, ",
      "colframe=maincolor, ",
      "boxrule=1pt, ",
      "arc=2mm, ",
      "boxsep=5pt, ",
      "left=10pt, ",
      "right=10pt, ",
      "title={\\textentitle{", title, "}}, ",
      "fonttitle=\\sffamily\\bfseries\\color{white}",
      "]\n", sep="")
  cat("\\hyphenpenalty=50 \\exhyphenpenalty=50 \\emergencystretch=4em \\sloppy\n")
  cat("\\hyphenation{пре-дста-вле-ние ис-сле-до-ва-ние ми-кро-би-о-та ба-кте-рии про-би-о-ти-ки}")
  cat(content)
  cat("\n\\end{tcolorbox}\n\n")
}

create_warningbox <- function(content, title = "Заявление об ограничении ответственности") {
  # Escape quotes in title if present
  title <- gsub('"', '\\"', title)
  
  cat("\\begin{tcolorbox}[",
      "colback=white, ",
      "colframe=accentcolor, ",
      "boxrule=1pt, ",
      "arc=2mm, ",
      "boxsep=5pt, ",
      "left=10pt, ",
      "right=10pt, ",
      "title={\\scalebox{1.2}{", title, "}}, ",
      "fonttitle=\\sffamily\\bfseries\\color{white} ",
      "]\n", sep="")
  cat("\\hyphenpenalty=50 \\exhyphenpenalty=50 \\emergencystretch=3em \\sloppy\n")
  cat(content)
  cat("\n\\end{tcolorbox}\n\n")
}

# To create 2 columns
create_side_by_side <- function(left_content, plot_filename, caption = NULL) {
  cat("\\begin{minipage}{0.55\\textwidth}\n")
  cat(left_content)  # This will be the output from capture.output()
  cat("\\end{minipage}\\hfill\n")
  
  cat("\\begin{minipage}{0.48\\textwidth}\n")
  cat("\\begin{figure}[H]\n")
  cat("\\centering\n")
  cat("\\includegraphics[width=\\linewidth]{", plot_filename, "}\n", sep="")
  if (!is.null(caption)) {
    cat("\\caption{\\textit{", caption, "}}\n", sep="")
  }
  cat("\\end{figure}\n")
  cat("\\end{minipage}\n\n")
  
  cat("\\vspace{1em}\n\n")
}

create_side_by_side2 <- function(left_content, plot_filename, caption = NULL) {
  cat("\\begin{minipage}{0.5\\textwidth}\n")
  cat(left_content)  # This will be the output from capture.output()
  cat("\\end{minipage}\\hfill\n")

  cat("\\hspace{0.03\\textwidth}")

  cat("\\begin{minipage}{0.42\\textwidth}\n")
  cat("\\begin{figure}[H]\n")
  cat("\\centering\n")
  cat("\\includegraphics[width=\\linewidth]{", plot_filename, "}\n", sep="")
  if (!is.null(caption)) {
    cat("\\caption{\\textit{", caption, "}}\n", sep="")
  }
  cat("\\end{figure}\n")
  cat("\\end{minipage}\n\n")
  
  cat("\\vspace{1em}\n\n")
}

capture_infobox <- function(content, title) {
  temp <- capture.output({
    create_infobox(content, title)
  })
  paste(temp, collapse="\n")
}

# Define a custom theme function for consistent plotting
theme_microbiome_report <- function(base_size = 16) {
  th <- theme_minimal(base_size = base_size) +
    theme(
      # Font
      text = element_text(family = "Montserrat"),

      # General plot styling
      plot.margin = margin(10, 15, 10, 10),
      plot.background = element_rect(fill = "white", color = NA),
      
      # Panel
      panel.grid.major.y = element_blank(),
      panel.grid.major.x = element_line(color = "gray85", linewidth = 0.6),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      panel.border = element_rect(color = "gray85", fill = NA, linewidth = 0.5),
      
      # Axes
      axis.title = element_text(size = base_size + 2, face = "bold", color = "gray20"),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      axis.text = element_text(size = base_size + 2, color = "gray20"),
      axis.text.x = element_text(margin = margin(t = 5)),
      axis.text.y = element_blank(),
      axis.ticks.x = element_line(color = "gray85")
    )  
  return(th)
}

# Define a consistent color palette
microbiome_colors <- list(
  participant = "#E18727",  # Orange for participant data
  population = "#0072B5FF",   # Blue for population data
  background = "grey95",      # Light grey for background elements
  positive = "#32854E",       # Green for positive comparisons
  negative = "#BC3C29"        # Red for negative comparisons
)
```

```{r setup, include=FALSE}
# Silently load required packages
suppressPackageStartupMessages({
  library(dplyr)      # For data manipulation
  library(ggplot2)    # For plotting
  library(stringr)    # For string manipulation
  library(forcats)    # For factor manipulation
  library(tidyr)      # For pivot_longer and pivot_wider
  library(vegan)      # For diversity indices
})

# Load data
abdata <- read.delim(params$abundance_file_path)

# Get phylum-level data from abdata
N <- 4
pie_phylum <- abdata %>%
  dplyr::filter(rank == "P") %>%
  mutate(name = trimws(name)) %>%
  select(name, contains(params$participant_id))
colnames(pie_phylum) <- c("name", "Percentage")
other_phyl_pct <- pie_phylum %>% arrange(desc(Percentage)) %>% slice((N+1):n()) %>% 
                      summarise(Percentage = sum(Percentage)) %>% pull(Percentage)
pie_phylum <- pie_phylum %>%
  arrange(desc(Percentage)) %>%
  mutate(
    group = ifelse(row_number() <= N, name, "Other species"),
    name = fct_recode(name, "Bacteroides" = "Bacteroidota", "Firmicutes" = "Bacillota",
              "Proteobacteria" = "Pseudomonadota"),
    label = ifelse(row_number() <= N, 
                  paste0(name, " (", round(Percentage, 1), "%)"),
                  paste0("Other groups (", round(other_phyl_pct, 1), "%)"))
  ) %>%
  group_by(group, label) %>%
  summarise(Percentage = sum(Percentage), .groups = "drop") %>%
  arrange(desc(Percentage)) %>%
  mutate(label = fct_inorder(label), 
          label = fct_relevel(label, paste0("Other groups (", round(other_phyl_pct, 1), "%)"),  
                    after = 5L))


# Get species-level data from abdata
N <- 20
pie_species <- abdata %>%
  dplyr::filter(rank == "S") %>%
  mutate(name = trimws(name)) %>%
  select(name, contains(params$participant_id))
colnames(pie_species) <- c("name", "Percentage")
other_spec_pct <- pie_species %>% arrange(desc(Percentage)) %>% slice((N+1):n()) %>% 
                      summarise(Percentage = sum(Percentage)) %>% pull(Percentage)
pie_species <- pie_species %>%
  arrange(desc(Percentage)) %>%
  mutate(
    group = ifelse(row_number() <= N, name, "Other species"),
    label = ifelse(row_number() <= N, 
                  paste0(name, " (", round(Percentage, 1), "%)"),
                  paste0("Other species (", round(other_spec_pct, 1), "%)"))
  ) %>%
  group_by(group, label) %>%
  summarise(Percentage = sum(Percentage), .groups = "drop") %>%
  arrange(desc(Percentage)) %>%
  mutate(label = fct_inorder(label), 
          label = fct_relevel(label, paste0("Other species (", round(other_spec_pct, 1), "%)"), after = 20L))

# Calculate diversity indices
abdiv <- abdata %>% dplyr::filter(rank == "S") %>% 
                    select(contains("report_bracken")) %>%
                    rename_at(c(colnames(.)[which(str_detect(colnames(.), 'report_bracken'))]), 
                              ~str_remove(str_remove(.x, "Sample"), '.kraken2.report_bracken'))
abdivflip <- as.data.frame(t(as.matrix(abdiv)))
shannon <- vegan::diversity(abdivflip, index = 'shannon')
df_shan <- data.frame(ID = names(shannon), `Shannon index` = shannon)
specrich <- vegan::specnumber(abdivflip)
df_spec <- data.frame(ID = names(specrich), `Species richness` = specrich)
dfdiv <- left_join(df_shan, df_spec, by = "ID") %>%
                          rename(`Shannon index` = Shannon.index, `Species richness` = Species.richness)
div_medians <- dfdiv %>% summarise(across(c(`Shannon index`, `Species richness`), 
                            list(median = ~median(.x, na.rm = TRUE), max = ~max(.x, na.rm = TRUE)))) %>% 
                          pivot_longer(., cols = 1:ncol(.), 
                                            names_sep = "_",
                                            names_to = c("metric", "var"), 
                                            values_to = "outcome") %>%
                          pivot_wider(., id_cols = var, names_from = metric, values_from = outcome)

# Select variables
namelist <- c(names(main_groups), names(taxa_explanations))
abdata2 <- abdata %>% 
  mutate(name = trimws(name)) %>%
  dplyr::filter(name %in% namelist) %>%
  mutate(rank = fct_relevel(rank, "D", "D1", "P", "C", "O", "F", "G", "S")) %>%
  arrange(rank)
rownames(abdata2) <- abdata2$name
abdata_filt <- abdata2 %>% select(contains("report_bracken")) %>%
                              rename_at(c(colnames(.)[which(str_detect(colnames(.), 'report_bracken'))]), 
                              ~str_remove(str_remove(.x, params$sample_prefix), '.kraken2.report_bracken'))
abdata_key <- abdata_filt %>% filter(rownames(.) %in% names(main_groups))
abdata_spec <- abdata_filt %>% filter(rownames(.) %in% names(taxa_explanations))

# Calculate the population medians per variable
abflip <- as.data.frame(t(as.matrix(abdata_filt)))
abundance_medians <- abflip %>% summarise(across(c(names(main_groups), names(taxa_explanations)), 
                                  list(median = ~median(.x, na.rm = TRUE), 
                                        max = ~max(.x, na.rm = TRUE)))
                                ) %>% pivot_longer(., cols = 1:ncol(.), names_sep = "_",
                                                  names_to = c("tax", "var"), 
                                                  values_to = "outcome") %>%
                                      pivot_wider(., id_cols = var, names_from = tax, values_from = outcome)



```

```{r intro, echo=FALSE, results='asis', warning=FALSE}
cat("\\subsection*{Введение}\n\n")
cat(introduction)

cat("\\newpage\n\n")
```

```{r diversity, echo=FALSE, results='asis', warning=FALSE}
participant_data3 <- dfdiv %>% filter(ID == params$participant_id)

cat("\\subsection*{Разнообразие бактерий}\n\n")
cat(diversity)
cat("\n\n")
for (metric in c("Shannon index", "Species richness")) {
    med <- div_medians[[which(div_medians$var == "median"), metric]]
    upper <- div_medians[[which(div_medians$var == "max"), metric]]
    
    # Format the values properly
    if(metric == "Shannon index") {
      participant_value <- format(round(participant_data3[[metric]], 2), nsmall = 2, decimal.mark = ",")
      median_value <- format(round(med, 2), nsmall = 2, decimal.mark = ",")
    } else {
      participant_value <- as.character(participant_data3[[metric]])
      median_value <- as.character(med)
    }
 
    # Add color formatting based on comparison
    comparison <- participant_data3[[metric]] > med

    metric_translations <- list(
      "Индекс Шеннона" = "Shannon index",
      "Видовое богатство" = "Species richness"
    )
    metric_russian <- names(metric_translations)[metric_translations == metric][1]

    # Create the result text with LaTeX bold formatting and conditional colors
    div_result <- paste0(
      "В данной выборке медианное значение ", metric, " составляет \\textbf{", median_value, "}. ",
      "В вашем образце этот показатель равен ", 
      ifelse(comparison, 
            "\\textbf{\\textcolor{goodcolor}{", 
            "\\textbf{\\textcolor{warncolor}{"),
      participant_value, 
      "}}."
    )

    div_text <- paste0(div_explanations[[metric]], div_result, "\n\n")
    infobox <- capture_infobox(div_text, metric)

    midpoint <- 0.5 * upper
    textplacing1 <- case_when(med < midpoint ~ 0, .default = 1)
    textplacing2 <- case_when(participant_data3[[metric]] < midpoint ~ 0, .default = 1)
    # Create the plot
    dir.create("figures", showWarnings = FALSE)
    pl <- ggplot(participant_data3) +
        geom_rect(aes(xmin = 0.7, xmax = 1.3, ymin = 0, ymax = upper[[1]]),
                  fill = microbiome_colors$background, color = NA, alpha = 0.5) +
        # Population median lollipop
        geom_segment(aes(x = 1, xend = 1, y = 0, yend = med[[1]]),
                     color = microbiome_colors$population, linewidth = 2, alpha = 0.7) +
        geom_point(aes(x = 1, y = med[[1]]), 
                   color = microbiome_colors$population, size = 10, alpha = 0.9) +
        # Participant value lollipop
        geom_segment(aes(x = 1, xend = 1, y = 0, yend = .data[[metric]]),
                     color = microbiome_colors$participant, linewidth = 2, alpha = 1.0) +
        geom_point(aes(x = 1, y = .data[[metric]]), 
                   color = microbiome_colors$participant, size = 10, alpha = 1.0) +
        # Annotations with arrows
        geom_segment(aes(x = 1.15, xend = 1.05, y = med[[1]], yend = med[[1]]), 
                     arrow = arrow(length = unit(0.3, "cm")), 
                     color = "black", linewidth = 0.8, alpha = 0.8) +
        geom_segment(aes(x = 0.85, xend = 0.95, y = .data[[metric]], yend = .data[[metric]]), 
                     arrow = arrow(length = unit(0.3, "cm")), 
                     color = "black", linewidth = 0.8, alpha = 0.8) +
        # Text labels (horizontal, no angle)
        annotate("text", x = 1.2, y = med[[1]], label = "Population median", 
                 color = microbiome_colors$population, size = 7, 
                 hjust = textplacing1, fontface = "bold", family = "Montserrat") +
        annotate("text", x = 0.8, y = participant_data3[[metric]], label = "You", 
                 color = microbiome_colors$participant, size = 7, 
                 hjust = textplacing2, fontface = "bold", family = "Montserrat") +
        # Scales and theme
        scale_y_continuous(limits = c(0, upper[[1]]), expand = c(0, 0)) +
        theme_microbiome_report() +
        labs(y = "Level", x = "") +
        coord_flip()
    plot_filename <- paste0("figures/report_", metric, ".png")
    ggsave(filename = plot_filename, plot = pl, width = 8, height = 3)

      create_side_by_side(infobox, plot_filename)
}
cat("\\newpage\n\n")
```

```{r phyla, echo=FALSE, results='asis', warning=FALSE}
cat("\\subsection*{Основные группы бактерий}\n\n")

phylum_colors <- c("#FF6F00FF", "#C71000FF", "#008EA0FF", "#8A4198FF", "grey")
pie1 <- ggplot(pie_phylum, aes(x = "", y = Percentage, fill = label)) +
          geom_bar(stat = "identity", width = 1) +
          coord_polar(theta = "y") +
          scale_fill_manual(values = phylum_colors) +
          labs(title = "", fill = "") +
          theme_void() +
          theme(legend.position = "right", legend.text = element_text(size = 14),
                text = element_text(family = "Montserrat"))
ggsave(filename = "figures/report_piephylum.png", plot = pie1, width = 7, height = 5)

create_side_by_side2(phylum_explanation, "figures/report_piephylum.png")

participant_data2 <- abdata_key %>% select(all_of(params$participant_id))
keygroups <- as.data.frame(t(as.matrix(participant_data2)))
for (taxon in c("Bacteroidota", "Bacillota", "Pseudomonadota")) {
  # Generate plot data
  med <- abundance_medians[which(abundance_medians$var == "median"), taxon][[1]]
  upper <- abundance_medians[which(abundance_medians$var == "max"), taxon][[1]]
  pt <- keygroups[[taxon]]

  # Format numbers
  pt_formatted <- format(round(pt, 2), nsmall = 2, decimal.mark = ",")
  med_formatted <- format(round(med, 2), nsmall = 2, decimal.mark = ",")
  comparison <- pt > med
  formatted_value <- ifelse(comparison,
                          paste0("\\textcolor{goodcolor}{\\textbf{", pt_formatted, "\\%}}"),
                          paste0("\\textcolor{warncolor}{\\textbf{", pt_formatted, "\\%}}"))

  phyla_translations <- list(
  "Bacteroidota" = "Bacteroidetes",
  "Bacillota" = "Firmicutes",
  "Pseudomonadota" = "Proteobacteria"
  )

  # Create the result text
  taxa_result <- paste0(
    "В данной выборке медианный уровень \\texten{", phyla_translations[[taxon]], 
    "} составляет \\textbf{", med_formatted, "\\%}. ",
    "В вашем образце этот показатель равен ", formatted_value, "."
  )
  taxa_text <- paste0(main_groups[[taxon]], " ", taxa_result)
  infobox <- capture_infobox(taxa_text, phyla_translations[[taxon]])

  midpoint <- 0.5 * upper
  textplacing1 <- case_when(med < midpoint ~ 0, .default = 1)
  textplacing2 <- case_when(pt < midpoint ~ 0, .default = 1)
  # Create the plot
  dir.create("figures", showWarnings = FALSE)
  pl <- ggplot() +
    # Adding a background rect
    geom_rect(aes(xmin = 0.7, xmax = 1.3, ymin = 0, ymax = upper),
              fill = microbiome_colors$background, color = NA, alpha = 0.5) +
    # Population median lollipop
    geom_segment(aes(x = 1, xend = 1, y = 0, yend = med),
                 color = microbiome_colors$population, linewidth = 2, alpha = 0.7) +
    geom_point(aes(x = 1, y = med), 
               color = microbiome_colors$population, size = 10, alpha = 0.9) +
               
    # Participant value lollipop
    geom_segment(aes(x = 1, xend = 1, y = 0, yend = pt),
                 color = microbiome_colors$participant, linewidth = 2, alpha = 1.0) +
    geom_point(aes(x = 1, y = pt), 
               color = microbiome_colors$participant, size = 10, alpha = 1.0) +
               
    # Annotations with arrows
    geom_segment(aes(x = 1.2, xend = 1.05, y = med, yend = med), 
                 arrow = arrow(length = unit(0.3, "cm")), 
                 color = "black", linewidth = 0.8, alpha = 0.4) +
    geom_segment(aes(x = 0.8, xend = 0.95, y = pt, yend = pt), 
                 arrow = arrow(length = unit(0.3, "cm")), 
                 color = "black", linewidth = 0.8, alpha = 0.4) +
                 
    # Text labels
    annotate("text", x = 1.25, y = med, 
             label = "Population median", color = microbiome_colors$population, 
             size = 7, hjust = textplacing1, fontface = "bold", family = "Montserrat") +
    annotate("text", x = 0.75, y = pt, 
             label = "You", color = microbiome_colors$participant, 
             size = 7, hjust = textplacing2, fontface = "bold", family = "Montserrat") +
             
    # Scales and theme
    scale_y_continuous(limits = c(0, upper), expand = c(0, 0), n.breaks = 5) +
    theme_microbiome_report() +
    labs(y = "Levels in %", x = "") +
    coord_flip()
    plot_filename <- paste0("figures/report_", taxon, ".png")
    ggsave(filename = plot_filename, plot = pl, width = 8, height = 3)

  create_side_by_side(infobox, plot_filename)
}
cat("\\newpage\n\n")
```

```{r species, echo=FALSE, results='asis', warning=FALSE}
cat("\\subsection*{Определенные виды бактерий}\n\n")
cat(species_explanation)

species_colors <- c("#FF6F00", "#EA4C00", "#D52900", "#B21D10", "#684B4B", "#1F7A86", "#1D7D9E",
"#4F619B", "#824598", "#7A5B98", "#697A98", "#629294", "#9F7F76", "#DC6D59",
"#EB7560", "#BEA098", "#90CAD0", "#A4C5D2", "#D1ADBD", "#FF95A8", "grey")
pie2 <- ggplot(pie_species, aes(x = "", y = Percentage, fill = label)) +
          geom_bar(stat = "identity", width = 1) +
          coord_polar(theta = "y") +
          scale_fill_manual(values = species_colors) +
          guides(fill = guide_legend(ncol = 1)) +
          labs(title = "", fill = "") +
          theme_void() +
          theme(legend.position = "right", legend.text = element_text(size = 11),
                text = element_text(family = "Montserrat"))
ggsave(filename = "figures/report_piespecies.png", plot = pie2, width = 8, height = 8)

cat("\\begin{figure}[H]\n")
cat("\\centering\n")
cat("\\includegraphics[height=15cm]{figures/report_piespecies.png}\n")
cat("\\end{figure}\n\n")

participant_data1 <- abdata_spec %>% select(all_of(params$participant_id))
specificbacteria <- as.data.frame(t(as.matrix(participant_data1)))
# Define pseudocount for log transformation
pseudocount <- 0.001

for (taxon in names(specificbacteria)) {
  # Get data points and add pseudocount for log scale
  pt <- specificbacteria[[taxon]]
  med <- as.numeric(abundance_medians[which(abundance_medians$var == "median"), taxon])
  upper <- as.numeric(abundance_medians[which(abundance_medians$var == "max"), taxon])
    
  # Format numbers
  pt_formatted <- format(round(pt, 2), nsmall = 2, decimal.mark = ",")
  med_formatted <- format(round(med, 2), nsmall = 2, decimal.mark = ",")
  comparison <- pt > med

  # Properly escape percent signs with double backslashes
  formatted_value <- ifelse(comparison,
                        paste0("\\textcolor{goodcolor}{\\textbf{", pt_formatted, "\\%}}"),
                        paste0("\\textcolor{warncolor}{\\textbf{", pt_formatted, "\\%}}"))

  # Create the result text with properly escaped percent signs
  taxa_result <- paste0(
    "В данной выборке медианный уровень \\texten{", taxon, "} составляет \\textbf{", med_formatted, "\\%}. ",
    "В вашем образце этот показатель равен ", formatted_value, "."
  )
  taxa_text <- paste0(taxa_explanations[[taxon]], " ", taxa_result)
  infobox <- capture_infobox(taxa_text, taxon)
  
  # Create plot
  dir.create("figures", showWarnings = FALSE)
  
  # Calculate positions for text labels
  log_midpoint <- sqrt((pseudocount) * (upper + pseudocount))
  textplacing1 <- case_when(med < log_midpoint ~ 0, .default = 1)
  textplacing2 <- case_when(pt < log_midpoint ~ 0, .default = 1)
  
  # Create the plot
  pl <- ggplot() +
    # Background reference area
    geom_rect(aes(xmin = 0.7, xmax = 1.3, ymin = pseudocount, ymax = upper + pseudocount),
              fill = microbiome_colors$background, color = NA, alpha = 0.5) +
              
    # Population median lollipop
    geom_segment(aes(x = 1, xend = 1, y = pseudocount, yend = med + pseudocount),
                 color = microbiome_colors$population, linewidth = 2, alpha = 0.7) +
    geom_point(aes(x = 1, y = med + pseudocount), 
               color = microbiome_colors$population, size = 10, alpha = 0.9) +
               
    # Participant value lollipop
    geom_segment(aes(x = 1, xend = 1, y = pseudocount, yend = pt + pseudocount),
                 color = microbiome_colors$participant, linewidth = 2, alpha = 1.0) +
    geom_point(aes(x = 1, y = pt + pseudocount), 
               color = microbiome_colors$participant, size = 10, alpha = 1.0) +
               
    # Annotations with arrows
    geom_segment(aes(x = 1.2, xend = 1.05, y = med + pseudocount, yend = med + pseudocount), 
                 arrow = arrow(length = unit(0.3, "cm")), 
                 color = "black", linewidth = 0.8, alpha = 0.4) +
    geom_segment(aes(x = 0.8, xend = 0.95, y = pt + pseudocount, yend = pt + pseudocount), 
                 arrow = arrow(length = unit(0.3, "cm")), 
                 color = "black", linewidth = 0.8, alpha = 0.4) +
                 
    # Text labels
    annotate("text", x = 1.25, y = med + pseudocount, 
             label = "Population median", color = microbiome_colors$population, 
             size = 7, hjust = textplacing1, fontface = "bold", family = "Montserrat") +
    annotate("text", x = 0.75, y = pt + pseudocount, 
             label = "You", color = microbiome_colors$participant, 
             size = 7, hjust = textplacing2, fontface = "bold", family = "Montserrat") +
             
    # Scale and theme  
    scale_y_log10(
      limits = c(pseudocount, max(upper + pseudocount)),
      expand = c(0, 0),
      n.breaks = 5,
      labels = function(x) paste0(round(x - pseudocount, 2), "%")
    ) +
    theme_microbiome_report() +
    labs(y = "Levels in %", x = "") +
    coord_flip()
  
  # Save and include the plot
  plot_filename <- paste0("figures/report_", taxon, ".png")
  ggsave(filename = plot_filename, plot = pl, width = 8, height = 3)
  
  create_side_by_side(infobox, plot_filename)
}

```
```{r conclusions, echo=FALSE, results='asis', warning=FALSE}
cat("\\subsection*{Дополнительные материалы для чтения}\n\n")
cat(readmore)
cat("\\vspace{1em}\n\n")
cat(create_warningbox(disclaimer, "Заявление об ограничении ответственности"))

```